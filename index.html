<!DOCTYPE html>
<html>
  <head>
    <title>Tiles freshness</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0;}
      .map { height: 100% }
    </style>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <link rel="stylesheet" href="lib/leaflet-control-geocoder/Control.Geocoder.css" />
    <script src="lib/leaflet-control-geocoder/Control.Geocoder.js"></script>
    <script src="leaflet-providers.js"></script>
    <script src="leaflet-geoip.js"></script>
    <script src="Bing.js"></script>
  </head>
  <body>
    <div id="map" class="map"></div>

    <script>
      var map = L.map('map');

      var baseLayers = {
        'Bing': new L.bingLayer("AuplXNWfv2r8wBiiFxD76a0vHWy6MEi3xARtk9oTiP-fC7LsEqEl5vE6qpjXiR2l", {maxZoom: 20}),
        'OpenStreetMap Default': L.tileLayer.provider('OpenStreetMap.Mapnik'),
        'OpenStreetMap German Style': L.tileLayer.provider('OpenStreetMap.DE'),
        'OpenStreetMap French Style': L.tileLayer.provider('OpenStreetMap.France'),
        'OpenStreetMap H.O.T.': L.tileLayer.provider('OpenStreetMap.HOT'),
        // CORS   'OpenStreetMap BlackAndWhite': L.tileLayer.provider('OpenStreetMap.BlackAndWhite'),
        // CORS   'OpenTopoMap': L.tileLayer.provider('OpenTopoMap'),
        'Thunderforest OpenCycleMap': L.tileLayer.provider('Thunderforest.OpenCycleMap'),
        'Thunderforest Landscape': L.tileLayer.provider('Thunderforest.Landscape'),
        // CORS   'Hydda Full': L.tileLayer.provider('Hydda.Full'),
      };
      baseLayers['Bing'].addTo(map);
      var overlayLayers = {
      };
      var layerControl = L.control.layers(baseLayers, overlayLayers, {collapsed: false}).addTo(map);
      // resize layers control to fit into view.
      function resizeLayerControl() {
        var layerControlHeight = document.body.clientHeight - (10 + 50);
        var layerControl = document.getElementsByClassName('leaflet-control-layers-expanded')[0];
        layerControl.style.overflowY = 'auto';
        layerControl.style.maxHeight = layerControlHeight + 'px';
      }
      map.on('resize', resizeLayerControl);
      resizeLayerControl();
      // start the map in South-East England
      //map.setView(new L.LatLng(51.3, 0.7),9);

      function display_fresh_date(tile, fresh_date) {
        var m;
        var re = /<img src=".*?" (.*)>/;
        if ((m = re.exec(tile.outerHTML)) !== null) {
          var span= "<p "+ m[1] + '><span style="background-color: white">' + fresh_date + "</span></p>";
          tile.outerHTML += span;
        };
      }

      for (var layer in baseLayers) {
        if (baseLayers.hasOwnProperty(layer)) {
          baseLayers[layer].on('tileload', function(e) {
            //    console.log(e.tile.outerHTML); // e is an event object (MouseEvent in this case)
            console.log(e.url); // e is an event object (MouseEvent in this case)
            var tile = e.tile;
            var fresh_date;
            if (/virtualearth/.exec(e.url)) {
              var xhr = new XMLHttpRequest();
              xhr.open('GET', "http://ssh.mlet.me/tile-freshness/headers.php?url=" + e.url, true);
              //xhr.setRequestHeader('X-VE-TILEMETA-CaptureDatesRange', '');
              xhr.send();
              xhr.onload = function(e) {
                if (this.status == 200) {

                  var m;
                  var re = /X-VE-TILEMETA-CaptureDatesRange: (\S+)\r/ ;
                  if ((m = re.exec(this.responseText)) !== null) {
                  console.log(m[1]);
                    display_fresh_date(tile, m[1]);
                  }
                }
              }
                  
            }
            else {
              var xhr = new XMLHttpRequest();
              xhr.open('GET', e.url + "/status", true);
              xhr.onload = function(e) {
                if (this.status == 200) {
                  console.log(this.responseText);

                  var m;
                  var re = /Last rendered at (\S+ \S+ \d+ \d+:\d+:\d+ \d+)/ ;
                  if ((m = re.exec(this.responseText)) !== null) {
                    display_fresh_date(tile, m[1]);
                  }
                }
              }
              xhr.send();
            }
          });
        };
      };


      map.setView(L.GeoIP.getPosition(),10);
      L.Control.geocoder().addTo(map);
    </script>
  </body>
</html>

